<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Execution Engine - Testing Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 14px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-success:hover {
            background: #229954;
        }

        .status-log {
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
        }

        .log-entry {
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-INFO {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .log-PENDING {
            background: #fff3e0;
            border-color: #ff9800;
        }

        .log-ROUTING {
            background: #e1f5fe;
            border-color: #03a9f4;
        }

        .log-BUILDING {
            background: #f3e5f5;
            border-color: #9c27b0;
        }

        .log-SUBMITTED {
            background: #e8f5e9;
            border-color: #4caf50;
        }

        .log-CONFIRMED {
            background: #c8e6c9;
            border-color: #2e7d32;
            font-weight: bold;
        }

        .log-FAILED {
            background: #ffebee;
            border-color: #c62828;
            font-weight: bold;
        }

        .log-WARNING {
            background: #fff9c4;
            border-color: #f57f17;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .dex-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }

        .dex-card {
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }

        .dex-card.winner {
            border-color: #27ae60;
            background: #e8f5e9;
        }

        .dex-name {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .dex-price {
            font-size: 1.5em;
            color: #667eea;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .queue-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .queue-bar {
            background: #e0e0e0;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .queue-fill {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .order-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .order-item {
            background: #f8f9fa;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
        }

        .order-id {
            font-family: monospace;
            font-size: 0.9em;
            color: #666;
        }

        .order-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 5px;
        }

        .status-CONFIRMED {
            background: #c8e6c9;
            color: #2e7d32;
        }

        .status-PENDING {
            background: #fff3e0;
            color: #e65100;
        }

        .status-ROUTING {
            background: #e1f5fe;
            color: #01579b;
        }

        .status-BUILDING {
            background: #f3e5f5;
            color: #4a148c;
        }

        .status-SUBMITTED {
            background: #e8f5e9;
            color: #1b5e20;
        }

        .status-FAILED {
            background: #ffebee;
            color: #c62828;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üöÄ Order Execution Engine - Testing Dashboard</h1>

        <div class="dashboard">
            <!-- Order Submission Form -->
            <div class="card">
                <h2>üìù Submit Order</h2>
                <form id="orderForm">
                    <div class="form-group">
                        <label for="inputToken">Input Token</label>
                        <select id="inputToken">
                            <option value="SOL">SOL (Solana)</option>
                            <option value="USDC">USDC</option>
                            <option value="USDT">USDT</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="outputToken">Output Token</label>
                        <select id="outputToken">
                            <option value="USDC">USDC</option>
                            <option value="SOL">SOL (Solana)</option>
                            <option value="USDT">USDT</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="amount">Amount</label>
                        <input type="number" id="amount" step="0.01" value="0.1" required>
                    </div>

                    <div class="button-group">
                        <button type="submit" class="btn-primary">Execute Order</button>
                        <button type="button" class="btn-secondary" onclick="submitMultipleOrders()">Submit 5
                            Orders</button>
                    </div>
                </form>

                <div class="queue-info">
                    <strong>Queue Status</strong>
                    <div style="margin-top: 10px;">
                        <div>Active Orders: <span id="activeOrders">0</span> / 10</div>
                        <div>Rate Limit: <span id="rateLimit">0</span> / 100 per minute</div>
                    </div>
                    <div class="queue-bar">
                        <div class="queue-fill" id="queueFill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="card">
                <h2>üìä Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalOrders">0</div>
                        <div class="stat-label">Total Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="confirmedOrders">0</div>
                        <div class="stat-label">Confirmed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="failedOrders">0</div>
                        <div class="stat-label">Failed</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgTime">0s</div>
                        <div class="stat-label">Avg Time</div>
                    </div>
                </div>

                <h3 style="margin-top: 25px; color: #667eea;">DEX Routing Comparison</h3>
                <div class="dex-comparison" id="dexComparison">
                    <div class="dex-card">
                        <div class="dex-name">üî∑ Raydium</div>
                        <div class="dex-price">--</div>
                        <div style="margin-top: 5px; font-size: 0.9em; color: #666;">Last Quote</div>
                    </div>
                    <div class="dex-card">
                        <div class="dex-name">üåä Meteora</div>
                        <div class="dex-price">--</div>
                        <div style="margin-top: 5px; font-size: 0.9em; color: #666;">Last Quote</div>
                    </div>
                </div>
            </div>

            <!-- Real-time Status Updates -->
            <div class="card full-width">
                <h2>üì° Real-time Status Updates (WebSocket)</h2>
                <div class="status-log" id="statusLog">
                    <div class="log-entry log-INFO">
                        <strong>INFO:</strong> Ready to submit orders. WebSocket will connect automatically.
                    </div>
                </div>
                <div class="button-group" style="margin-top: 15px;">
                    <button class="btn-secondary" onclick="clearLog()">Clear Log</button>
                    <button class="btn-danger" onclick="testConcurrency()">Test Concurrency (10 orders)</button>
                </div>
            </div>

            <!-- Recent Orders -->
            <div class="card full-width">
                <h2>üìã Recent Orders</h2>
                <div class="order-list" id="orderList">
                    <div style="text-align: center; color: #999; padding: 20px;">
                        No orders yet. Submit an order to get started!
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let activeOrders = new Map();
        let orderStats = {
            total: 0,
            confirmed: 0,
            failed: 0,
            times: []
        };
        let lastDexQuotes = { raydium: null, meteora: null };

        // Add log entry
        function addLog(status, message, data = {}) {
            const log = document.getElementById('statusLog');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${status}`;

            let content = `<strong>${status}:</strong> ${message}`;
            if (data.orderId) {
                content += ` <span class="order-id">[${data.orderId.substring(0, 8)}...]</span>`;
            }
            if (data.dex) {
                content += ` <span style="color: #667eea;">[${data.dex}]</span>`;
            }
            if (data.price) {
                content += ` <span style="color: #27ae60;">Price: ${data.price}</span>`;
            }
            if (data.txHash) {
                content += ` <span style="color: #2196f3;">TX: ${data.txHash}</span>`;
            }

            entry.innerHTML = content;
            log.insertBefore(entry, log.firstChild);

            // Keep only last 50 entries
            while (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }

        function clearLog() {
            const log = document.getElementById('statusLog');
            log.innerHTML = '<div class="log-entry log-INFO"><strong>INFO:</strong> Log cleared.</div>';
        }

        // Update statistics
        function updateStats() {
            document.getElementById('totalOrders').textContent = orderStats.total;
            document.getElementById('confirmedOrders').textContent = orderStats.confirmed;
            document.getElementById('failedOrders').textContent = orderStats.failed;

            if (orderStats.times.length > 0) {
                const avg = orderStats.times.reduce((a, b) => a + b, 0) / orderStats.times.length;
                document.getElementById('avgTime').textContent = avg.toFixed(1) + 's';
            }

            // Update queue visualization
            const activeCount = activeOrders.size;
            document.getElementById('activeOrders').textContent = activeCount;
            document.getElementById('queueFill').style.width = (activeCount / 10 * 100) + '%';
        }

        // Update DEX comparison
        function updateDexComparison(dex, price) {
            lastDexQuotes[dex.toLowerCase()] = price;

            const raydiumCard = document.querySelector('.dex-comparison .dex-card:nth-child(1)');
            const meteoraCard = document.querySelector('.dex-comparison .dex-card:nth-child(2)');

            if (lastDexQuotes.raydium !== null) {
                raydiumCard.querySelector('.dex-price').textContent = '$' + lastDexQuotes.raydium;
            }
            if (lastDexQuotes.meteora !== null) {
                meteoraCard.querySelector('.dex-price').textContent = '$' + lastDexQuotes.meteora;
            }

            // Highlight winner
            raydiumCard.classList.remove('winner');
            meteoraCard.classList.remove('winner');

            if (lastDexQuotes.raydium !== null && lastDexQuotes.meteora !== null) {
                if (lastDexQuotes.raydium > lastDexQuotes.meteora) {
                    raydiumCard.classList.add('winner');
                } else if (lastDexQuotes.meteora > lastDexQuotes.raydium) {
                    meteoraCard.classList.add('winner');
                }
            } else if (dex === 'RAYDIUM') {
                raydiumCard.classList.add('winner');
            } else if (dex === 'METEORA') {
                meteoraCard.classList.add('winner');
            }
        }

        // Add order to recent list
        function addOrderToList(orderId, status, data = {}) {
            const orderList = document.getElementById('orderList');

            // Remove "no orders" message
            if (orderList.querySelector('div[style*="text-align: center"]')) {
                orderList.innerHTML = '';
            }

            let orderItem = document.getElementById('order-' + orderId);
            if (!orderItem) {
                orderItem = document.createElement('div');
                orderItem.id = 'order-' + orderId;
                orderItem.className = 'order-item';
                orderList.insertBefore(orderItem, orderList.firstChild);
            }

            let content = `
                <div class="order-id">Order ID: ${orderId}</div>
                <div><span class="order-status status-${status}">${status}</span></div>
            `;

            if (data.dex) {
                content += `<div style="margin-top: 5px;">DEX: <strong>${data.dex}</strong></div>`;
            }
            if (data.price) {
                content += `<div>Price: <strong>$${data.price}</strong></div>`;
            }
            if (data.txHash) {
                content += `<div>TX: <code style="font-size: 0.85em;">${data.txHash}</code></div>`;
            }

            orderItem.innerHTML = content;

            // Keep only last 20 orders
            while (orderList.children.length > 20) {
                orderList.removeChild(orderList.lastChild);
            }
        }

        // Connect WebSocket
        function connectWebSocket(orderId) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ orderId }));
                return;
            }

            // Use wss:// for HTTPS, ws:// for HTTP
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/api/orders/ws`);

            ws.onopen = () => {
                console.log('WebSocket connected');
                addLog('INFO', 'WebSocket connected');
                ws.send(JSON.stringify({ orderId }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                console.log('WebSocket message received:', data);

                const status = data.status || data.data?.status;
                const orderId = data.orderId;

                if (status === 'ROUTING') {
                    addLog('ROUTING', 'Finding best DEX price...', { orderId });
                    addOrderToList(orderId, status);
                } else if (status === 'BUILDING') {
                    const dex = data.data?.dex || data.dex;
                    const price = data.data?.price || data.price;
                    addLog('BUILDING', `Building transaction on ${dex}`, { orderId, dex, price });
                    updateDexComparison(dex, price);
                    addOrderToList(orderId, status, { dex, price });
                } else if (status === 'SUBMITTED') {
                    addLog('SUBMITTED', 'Transaction submitted to network', { orderId });
                    addOrderToList(orderId, status);
                } else if (status === 'CONFIRMED') {
                    const txHash = data.data?.txHash || data.txHash;
                    const price = data.data?.price || data.price;
                    addLog('CONFIRMED', 'Order completed successfully!', { orderId, txHash, price });
                    addOrderToList(orderId, status, { txHash, price });

                    if (activeOrders.has(orderId)) {
                        const startTime = activeOrders.get(orderId);
                        const duration = (Date.now() - startTime) / 1000;
                        orderStats.times.push(duration);
                        activeOrders.delete(orderId);
                    }
                    orderStats.confirmed++;
                    updateStats();
                } else if (status === 'FAILED') {
                    const error = data.data?.error || data.error;
                    addLog('FAILED', `Order failed: ${error}`, { orderId });
                    addOrderToList(orderId, status, { error });

                    activeOrders.delete(orderId);
                    orderStats.failed++;
                    updateStats();
                } else if (status === 'PENDING') {
                    addLog('PENDING', 'Order submitted to queue', { orderId });
                    addOrderToList(orderId, status);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addLog('WARNING', 'WebSocket connection error');
            };

            ws.onclose = () => {
                console.log('WebSocket closed');
                addLog('WARNING', 'Connection closed unexpectedly');
            };
        }

        // Submit order
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const inputToken = document.getElementById('inputToken').value;
            const outputToken = document.getElementById('outputToken').value;
            const amount = parseFloat(document.getElementById('amount').value);

            if (inputToken === outputToken) {
                addLog('WARNING', 'Input and output tokens must be different');
                return;
            }

            addLog('INFO', `Submitting order: ${amount} ${inputToken} ‚Üí ${outputToken}`);

            try {
                const response = await fetch('/api/orders/execute', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ inputToken, outputToken, amount })
                });

                const data = await response.json();
                const orderId = data.orderId;

                addLog('PENDING', `Order created: ${orderId}`, { orderId });

                activeOrders.set(orderId, Date.now());
                orderStats.total++;
                updateStats();

                connectWebSocket(orderId);

            } catch (error) {
                addLog('FAILED', `Error: ${error.message}`);
            }
        });

        // Submit multiple orders
        async function submitMultipleOrders() {
            const count = 5;
            addLog('INFO', `Submitting ${count} orders concurrently...`);

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    document.getElementById('amount').value = (Math.random() * 0.5 + 0.1).toFixed(2);
                    document.getElementById('orderForm').dispatchEvent(new Event('submit'));
                }, i * 200);
            }
        }

        // Test concurrency
        async function testConcurrency() {
            const count = 10;
            addLog('INFO', `üöÄ Testing concurrency with ${count} orders...`);

            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    document.getElementById('amount').value = (Math.random() * 1 + 0.1).toFixed(2);
                    document.getElementById('orderForm').dispatchEvent(new Event('submit'));
                }, i * 100);
            }
        }

        // Initialize
        updateStats();
    </script>
</body>

</html>